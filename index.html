<!DOCTYPE html>
<html>
    <head>
     <title>SMYS TALK</title>
     <meta charset="utf-8">
    <meta name="description" content="대화공간">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
      /* Mobile-first responsive styles */
      :root{--primary:#7844e8;--muted:#f6f6fb;--dark:#2e2e2e}
      html,body{height:100%;}
      body.site-body{font-family:Poppins, 'Noto Sans KR', sans-serif; margin:0; background:#fff; color:var(--dark); -webkit-font-smoothing:antialiased}
      .hero{background-color:#703fda;color:#fff;text-align:center;padding:18px}
      .hero h1{color:#fff;font-weight:300;margin:0;font-size:20px}
      .hero p{margin-top:8px}
      .container{max-width:560px;margin:24px auto;padding:0 16px;box-sizing:border-box}
      .card{background:var(--muted);padding:18px;border-radius:8px}
      img.responsive{width:100%;height:auto;display:block;border-radius:6px}
      .comment-form input,.comment-form textarea{width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-family:inherit}
      .btn{display:inline-block;padding:12px 16px;background:var(--primary);color:#fff;border-radius:6px;border:none;cursor:pointer;font-weight:600}
      #commentsList .comment{background:#fff;padding:12px;border-radius:6px;margin-bottom:12px;border-left:4px solid var(--primary)}
      .btn-delete{background:transparent;border:none;color:#d9363e;font-weight:600;cursor:pointer;padding:6px 8px;border-radius:4px}
      .btn-delete:hover{background:#fff0f0}
      /* Fixed bottom comment form */
      .comment-fixed{position:fixed;left:0;right:0;bottom:0;background:#ffffff;border-top:1px solid #eee;padding:12px;box-shadow:0 -4px 16px rgba(0,0,0,0.06);z-index:1000}
      .comment-fixed .inner{max-width:560px;margin:0 auto}
      body.site-body{padding-bottom:280px} /* initial padding; will be adjusted via JS */
      @media(min-width:720px){ body.site-body{padding-bottom:320px} }
      /* Admin modal adjustments */
      #adminModal .modal-inner{width:92%;max-width:600px;margin:40px auto;padding:20px}
      @media(min-width:720px){
        .hero h1{font-size:28px}
        .container{padding:0}
        #adminModal .modal-inner{padding:30px}
      }
    </style>
    <meta property="og:title" content="SYMS TALK">
     <link rel="preconnect" href="https://fonts.googleapis.com">
     <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
     <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR&family=Poppins&display=swap" rel="stylesheet">
     </head>
    <body class="site-body">
     <div class="hero">
      <h1>대화공간</h1>
      <p>
        <span style="font-weight:700;">욕하거나 사칭하지 마세요</span>
      </p>
    </div>
    <div class="container">
      
      <h2 style="color: #2e2e2e; font-size: 20px">
        <br>
        
      </h2>
      <img class="responsive" src="http://image.toast.com/aaaaaaq/iamschool/test/LOGO_IMAGE/170337890708924164.PNG">
      <p>
    
           </p>      <p style="text-align: center;">        <a href="https://www.youtube.com/shorts/YEhDlkBl_D0" style="font-size: 32px; display: inline-block;">
          ㅊㅇㅅ TlqkftoRL
        </a>
      </p>
      
      
    <div class="container" style="margin-top:30px">
     
    </div>
    <div style="margin-top:30px;">
      <div style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <h3 style="color:#2e2e2e;margin:0">댓글 목록</h3>
        <button id="adminToggle" type="button" class="btn" style="background:#2e2e2e;color:#fff;padding:8px 10px;font-size:12px">관리자 로그인</button>
      </div>
      <div id="commentsList"></div>
    </div>
    <!-- Fixed bottom comment input -->
    <div class="comment-fixed" aria-label="코멘트 입력 영역">
      <div class="inner">
        <h3 style="color:#2e2e2e;margin:0 0 8px 0">코멘트를 남겨주세요</h3>
        <form id="commentForm" class="comment-form" style="display:flex;flex-direction:column;gap:10px;">
          <input type="text" id="name" placeholder="이름" required>
          <textarea id="content" placeholder="코멘트를 입력하세요" required style="min-height:90px;resize:vertical"></textarea>
          <div style="display:flex;justify-content:flex-end;align-items:center;gap:10px">
            <div id="message" style="color:#7844e8"></div>
            <button type="submit" class="btn">제출</button>
          </div>
        </form>
      </div>
    </div>
    <!-- 상단 중복 문구 제거됨 -->
        <script>
        (function(){
          const API_BASE = 'https://asdf-1-9s27.onrender.com';
          const form = document.getElementById('commentForm');
          const nameInput = document.getElementById('name');
          const contentInput = document.getElementById('content');
          const messageDiv = document.getElementById('message');
          const commentsList = document.getElementById('commentsList');
          const fixedBar = document.querySelector('.comment-fixed');
          const bodyEl = document.querySelector('body.site-body');

          let adminToken = '';
          let isAdmin = false;

          function showAlert(msg){
            messageDiv.textContent = msg;
            messageDiv.style.color = '#7844e8';
            setTimeout(()=> messageDiv.textContent = '', 3000);
          }

          // 관리자 기능 제거됨 (서버에서 관련 엔드포인트 제거됨)

          // 댓글 로드 (응답이 JSON이 아닐 때 친절하게 처리)
          async function loadComments(){
            try{
              const res = await fetch(API_BASE + '/api/comments');
              const ct = res.headers.get('content-type') || '';
              if(!res.ok){
                const text = await res.text();
                console.error('댓글 로드 실패:', res.status, text);
                commentsList.innerHTML = '<p style="color:#ff0000;">댓글을 불러올 수 없습니다.</p>';
                return;
              }
              if(!ct.includes('application/json')){
                const text = await res.text();
                console.error('댓글 로드: JSON 아님, 응답:', text.slice(0,200));
                commentsList.innerHTML = '<p style="color:#ff0000;">댓글을 불러올 수 없습니다.</p>';
                return;
              }
              const comments = await res.json();
              commentsList.innerHTML='';
              if(!Array.isArray(comments)) return;
              comments.forEach(c=>{
                const div=document.createElement('div');
                div.className='comment';
                div.setAttribute('data-id', String(c.id||''));
                const delBtn = isAdmin ? `<button type="button" class="btn-delete" data-id="${String(c.id||'')}">삭제</button>` : '';
                div.innerHTML=`
                  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px">
                    <strong style="color:#7844e8">${escapeHtml(c.name)}</strong>
                    ${delBtn}
                  </div>
                  <p style="margin:5px 0;color:#2e2e2e">${escapeHtml(c.content)}</p>
                  <small style="color:#999">${escapeHtml(c.date)}</small>
                `;
                commentsList.appendChild(div);
              });
            }catch(err){ console.error('댓글 로드 오류:',err); commentsList.innerHTML = '<p style="color:#ff0000;">댓글을 불러올 수 없습니다.</p>'; }
          }

          // 폼 제출
          if(form){
            form.addEventListener('submit', async (e)=>{
              e.preventDefault();
              try{
                const res = await fetch(API_BASE + '/api/comments',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({name:nameInput.value,content:contentInput.value})});
                const ct = res.headers.get('content-type') || '';

                
                if(!res.ok){
                  const text = await res.text();
                  showAlert('오류: 서버 응답 실패');
                  console.error('댓글 제출 실패:', res.status, text);
                  return;
                }
                if(!ct.includes('application/json')){
                  const text = await res.text();
                  showAlert('오류: 서버가 JSON을 반환하지 않습니다');
                  console.error('댓글 제출: JSON 아님, 응답:', text.slice(0,300));

                  return;
                }
                const data = await res.json();
                if(data.success){ showAlert('댓글이 등록되었습니다!'); nameInput.value=''; contentInput.value=''; loadComments(); }
                else showAlert(data.message||'오류');
              }catch(err){ showAlert('오류: '+err.message); }
            });
          }

          // 안전한 HTML 이스케이프
          function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;"})[c]); }

          // 초기 로드
          loadComments();

          // 댓글 삭제 처리 (이벤트 위임)
          commentsList.addEventListener('click', async (e)=>{
            const t = e.target;
            if(!(t && t.closest)) return;
            const btn = t.closest('.btn-delete');
            if(!btn) return;
            const id = btn.getAttribute('data-id');
            if(!id) return;
            if(!confirm('이 댓글을 삭제하시겠습니까?')) return;
            try{
              if(!isAdmin || !adminToken){ showAlert('관리자 권한이 필요합니다'); return; }
              // 유니코드 토큰도 안전하게 전송되도록 Base64로 인코딩
              const tokenB64 = (typeof btoa === 'function')
                ? btoa(unescape(encodeURIComponent(adminToken)))
                : adminToken; // 폴백
              const res = await fetch(API_BASE + '/api/comments/' + encodeURIComponent(id), {
                method:'DELETE',
                headers: { 'x-admin-token-b64': tokenB64 }
              });
              const ct = res.headers.get('content-type')||'';
              if(!res.ok){
                const text = await res.text();
                showAlert('삭제 실패');
                console.error('삭제 실패:', res.status, text);
                return;
              }
              const data = ct.includes('application/json') ? await res.json() : {};
              if(data && data.success){
                showAlert('댓글이 삭제되었습니다');
                loadComments();
              }else{
                showAlert('삭제 실패');
              }
            }catch(err){
              console.error('삭제 오류:', err);
              showAlert('삭제 오류: '+err.message);
            }
          });

          // 관리자 로그인/해제
          const adminToggle = document.getElementById('adminToggle');
          if(adminToggle){
            adminToggle.addEventListener('click', async ()=>{
              if(!isAdmin){
                const token = (prompt('관리자 토큰을 입력하세요')||'').trim();
                if(!token) return;
                try{
                  // 토큰 검증 요청 (Base64 인코딩)
                  const tokenB64 = (typeof btoa === 'function')
                    ? btoa(unescape(encodeURIComponent(token)))
                    : token;
                  const res = await fetch(API_BASE + '/api/admin/verify', {
                    method: 'GET',
                    headers: { 'x-admin-token-b64': tokenB64 }
                  });
                  if(!res.ok){
                    showAlert('권한이 없습니다. 토큰을 확인하세요');
                    return;
                  }
                  // 성공 시에만 관리자 모드 활성화
                  adminToken = token;
                  isAdmin = true;
                  adminToggle.textContent = '관리자 모드 해제';
                  showAlert('관리자 모드 활성화');
                  loadComments();
                }catch(err){
                  console.error('토큰 검증 오류:', err);
                  showAlert('토큰 검증 실패');
                }
              }else{
                isAdmin = false;
                adminToken = '';
                adminToggle.textContent = '관리자 로그인';
                showAlert('관리자 모드 해제됨');
                loadComments();
              }
            });
          }

          // 고정 입력 폼 높이에 맞춰 하단 패딩 자동 조정
          function adjustBottomPadding(){
            if(!fixedBar || !bodyEl) return;
            const h = fixedBar.offsetHeight || 0;
            const extra = 40; // 시각적 여유
            bodyEl.style.paddingBottom = (h + extra) + 'px';
          }
          window.addEventListener('resize', adjustBottomPadding, { passive: true });
          const ro = new ResizeObserver(adjustBottomPadding);
          if(fixedBar && typeof ResizeObserver !== 'undefined'){ ro.observe(fixedBar); }
          // 폼 내용 변화로 높이가 달릴 수 있음
          if(contentInput){ contentInput.addEventListener('input', adjustBottomPadding); }
          // 초기 2프레임 후 안정화
          requestAnimationFrame(()=> requestAnimationFrame(adjustBottomPadding));
        })();
        </script>
    </div>
    <div style="background-color: #f6f6fb; width: 550px;margin: 32px;margin: 0 auto">
      
      </p>
    </div>
    <div style="background-color: #7844e8; color: #ffffff;padding: 20px">
      <h2 style="text-align: center;">
        setter 안쓰고 만들었으니까
        해킹 시도하지 말아주세요
      </h2>
    </div>
    <div style="background-color: #2e2e2e; color: #ffffff; text-align: center;padding: 50px">
      <p>
        render 도메인을 통해 서버 운영중입니다 ㅣ도배시 서버 접속 막을게요
      </p>
      <p>
       토스뱅크 1908-9485-6032
      </p>
      <p>
        (주)Cheeseball_United ㅣ 문의:010-5534-7351
      </p>
    </div>
   </body>
</html>